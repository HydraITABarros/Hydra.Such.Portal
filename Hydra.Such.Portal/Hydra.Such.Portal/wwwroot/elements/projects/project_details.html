
<link rel="import" href="/lib/paper-tabs-master/paper-tab.html" />
<link rel="import" href="/lib/paper-tabs-master/paper-tabs.html" />
<link rel="import" href="/lib/iron-pages-master/iron-pages.html" />
<link rel="import" href="/lib/iron-menu-behavior/iron-menubar-behavior.html" />
<link rel="import" href="/lib/iron-form/iron-form.html" />
<link rel="import" href="/lib/paper-button/paper-button.html" />
<link rel="import" href="/lib/paper-checkbox-master/paper-checkbox.html" />
<link rel="import" href="/lib/paper-dialog/paper-dialog.html" />
<link rel="import" href="/lib/paper-dialog-behavior/paper-dialog-behavior.html" />
<link rel="import" href="/lib/paper-input/paper-input.html" />
<link rel="import" href="/lib/paper-tabs-master/paper-tab.html" />
<link rel="import" href="/lib/paper-tabs-master/paper-tabs.html" />
<link rel="import" href="/lib/paper-toast-master/paper-toast.html" />
<link rel="import" href="/lib/paper-tooltip-master/paper-tooltip.html">
<link rel="import" href="/lib/paper-toast-master/paper-toast.html" />
<link rel="import" href="/lib/such-selectbox/such-selectbox.html">
<link rel="import" href="/lib/vaadin-valo-theme/vaadin-date-picker.html">
<link rel="import" href="/lib/vaadin-valo-theme/vaadin-checkbox.html">
<link rel="import" href="/lib/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="/lib/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="/lib/vaadin-grid/vaadin-grid.html">
<link rel="import" href="/lib/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="/lib/vaadin-combo-box/vaadin-combo-box.html" />
<link rel="import" href="/lib/such-textarea/such-textarea.html">
<link rel="import" href="/lib/such-selectbox/such-selectbox.html">
<link rel="import" href="/lib/such-dropdown-menu/such-dropdown-menu.html" />

<dom-module id="x-projectdetails">
    <template>
        <!-- STYLES -->
        <link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.css" />
        <link rel="stylesheet" href="/lib/font-awesome-4.7.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="/css/main.css" />
        <style>
            vaadin-combo-box {
                margin-top: 0px !important;
                width: 100% !important;
            }

            vaadin-date-picker {
                margin-top: 0px !important;
                width: 100% !important;
            }

            vaadin-text-field {
                margin-top: 0px !important;
                width: 100%;
            }

            .break_clear {
                margin-top: 15px;
            }
        </style>


        <!-- DROPDOWNS POPULATE -->
        <iron-ajax url="/PopulateDropdowns/GetProjectStatus" last-response="{{LProjectStatus}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetProjectCategories" last-response="{{LProjectCategories}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetProjectTypes" last-response="{{LProjectTypes}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetServiceObjects" last-response="{{LProjectServiceObjects}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <!--<iron-ajax url="/PopulateDropdowns/GetCountabGroupTypes" last-response="{{LProjectCountabGroupTypes}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
    <iron-ajax url="/PopulateDropdowns/GetCountabGroupTypesOM" last-response="{{LProjectCountabGroupTypesOM}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>-->
        <iron-ajax url="/PopulateDropdowns/GetFunctionalAreaCode" last-response="{{LProjectFunctionalAreaCodes}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <!--<iron-ajax url="/PopulateDropdowns/GetResponsabilityCenterCode" last-response="{{LProjectResponsabilityCenterCodes}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>-->
        <iron-ajax url="/PopulateDropdowns/GetRegionCode" last-response="{{LProjectRegionCodes}}" auto method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetProjectContractsByClient" last-response="{{LProjectContracts}}" id="projects_ajax" method="post" handle-as="json" content-type="application/json"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetGroupContProject" last-response="{{LProjectGroupContab}}" auto method="post" handle-as="json" content-type="application/json" id="groupcontab_ajax"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetEmployees" last-response="{{LProjectEmployees}}" auto method="post" handle-as="json" content-type="application/json" id="employees_ajax"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetAllClientsComboGrid" last-response="{{LProjectClients}}" auto method="post" handle-as="json" content-type="application/json" id="clients_ajax"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetAreas" last-response="{{LAreas}}" auto method="post" handle-as="json" content-type="application/json" id="clients_ajax"></iron-ajax>
        <iron-ajax url="/PopulateDropdowns/GetNAVShippingAddressesByClientNoAsVM" last-response="{{ClientShippingAddresses}}" method="post" handle-as="json" content-type="application/json" id="shippinhAddress_ajax"></iron-ajax>

        <iron-ajax url="/PopulateDropdowns/GetAllResponsabilityCenterCodeFilterByAreaCode"
                   last-response="{{LProjectResponsabilityCenterCodes}}"
                   method="post"
                   handle-as="json"
                   id="page_GetAllResponsabilityCenterCodeFilterByAreaCode_ajax"
                   content-type="application/json"></iron-ajax>

        <iron-ajax url="/PopulateDropdowns/GetCountabGroupTypes"
                   last-response="{{LProjectCountabGroupTypes}}"
                   method="post"
                   handle-as="json"
                   id="page_getGroupContabProjectType_ajax"
                   content-type="application/json"></iron-ajax>

        <!-- PROJECT CRUDS -->
        <iron-ajax url="/Projetos/GetProjectDetails"
                   last-response="{{data}}"
                   method="post"
                   handle-as="json"
                   id="page_databound_ajax"
                   on-response="_responseProcessor"
                   content-type="application/json"></iron-ajax>

        <iron-ajax url="/Projetos/DeleteProject"
                   last-response="{{deletedData}}"
                   method="post"
                   handle-as="json"
                   id="ajax_delete_project"
                   on-response="_responseDeleteProcessor"
                   content-type="application/json"></iron-ajax>

        <iron-ajax url="/Projetos/TerminarProject"
                   last-response="{{terminarData}}"
                   method="post"
                   handle-as="json"
                   id="ajax_terminar_project"
                   on-response="_responseTerminarProcessor"
                   content-type="application/json"></iron-ajax>

        <iron-ajax url="/Projetos/ReabrirProject"
                   last-response="{{reabrirData}}"
                   method="post"
                   handle-as="json"
                   id="ajax_reabrir_project"
                   on-response="_responseReabrirProcessor"
                   content-type="application/json"></iron-ajax>

        <iron-ajax url="/Projetos/DuplicarProject"
                   last-response="{{duplicarData}}"
                   method="post"
                   handle-as="json"
                   id="ajax_duplicar_project"
                   on-response="_responseDuplicarProcessor"
                   content-type="application/json"></iron-ajax>

        <iron-ajax url="/Projetos/EnviarAprovacao"
                   last-response="{{enviarAprovacao}}"
                   method="post"
                   handle-as="json"
                   id="page_EnviarAprovacao_ajax"
                   on-response="_responseEnviarAprovacao"
                   content-type="application/json"></iron-ajax>

        <!-- PROJECT Valitador -->
        <iron-ajax url="/Projetos/ValidateNumeration"
                   last-response="{{validateResponse}}"
                   method="post"
                   handle-as="json"
                   id="page_validator_ajax"
                   on-response="_responseValidatorProcessor"
                   content-type="application/json"></iron-ajax>

        <!-- Address databound -->
        <iron-ajax url="/Projetos/GetAddressData"
                   last-response="{{addressData}}"
                   method="post"
                   handle-as="json"
                   id="address_ajax"
                   content-type="application/json"></iron-ajax>

        <iron-ajax url="/Projetos/GoFaturasNotas"
                   id="ajax_GoFaturasNotas_ajax">
        </iron-ajax>

        <template is="dom-if" if="{{ !_isCreate }}">
            <div class="subMenu">
                <paper-button class="tablinks" on-tap="_goBack" title="Voltar"><i class="fa fa-arrow-left" aria-hidden="true"></i> Voltar</paper-button>

                <template is="dom-if" if="{{ _permissions.create }}">
                    <paper-button id="btnProjectAdd" class="tablinks" on-tap="_createNewProject"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp; Novo</paper-button>
                    <paper-button id="btnProjectDuplicate" class="tablinks" on-tap="_DuplicateProject"><i class="fa fa-copy" aria-hidden="true"></i>&nbsp; Duplicar</paper-button>
                </template>

                <template is="dom-if" if="{{ data.verMenu }}">
                    <paper-button id="btnProjectDiary" class="tablinks" on-tap="_OpenProjectDiary"><i class="fa fa-eye" aria-hidden="true"></i>&nbsp; Diário de Projeto</paper-button>

                    <template is="dom-if" if="{{ _permissions.create }}">
                        <paper-button id="btnInvoiceAut" class="tablinks" on-tap="_OpenInvoice"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp; Autorização Faturação</paper-button>
                    </template>
                </template>

                <such-dropdown-menu on-value-changed="_viewMenuConsultarItemSelected" title="Consultar" items='[[ _viewMenuConsultarItems ]]'></such-dropdown-menu>
                <such-dropdown-menu on-value-changed="_viewMenuPreMovItemSelected" title="Pré-Movimentos" items='[[ _viewMenuPreMovItems ]]'></such-dropdown-menu>

                <template is="dom-if" if="{{ data.verMenu }}">
                    <paper-button id="btnProjectAdd" class="tablinks" on-tap="_terminarProject"><i class="fa fa-remove" aria-hidden="true"></i>&nbsp; Terminar</paper-button>
                </template>

                <template is="dom-if" if="{{ data.enviarParaAprovacao }}">
                    <paper-button id="btnEnviarAprovacao" class="tablinks" on-tap="_EnviarAprovacao"><i class="fa fa-arrow-right" aria-hidden="true"></i>&nbsp; Enviar Para Aprovação</paper-button>
                </template>

                <paper-button id="btn_imprimirMovimentos" class="tablinks" on-tap="_printMovimentos" title="Imprimir"><i class="fa fa-print" aria-hidden="true"></i> Imprimir Extrato</paper-button>

                <template is="dom-if" if="{{ _projectclosed }}">
                    <paper-button id="btnReabrirProjeto" class="tablinks" on-tap="_ReabrirProjeto"><i class="fa fa-check" aria-hidden="true"></i>&nbsp; Reabrir Projeto</paper-button>
                </template>

                <!--<paper-button class="tablinks" on-tap="_goBack" title="Voltar"><i class="fa fa-arrow-left" aria-hidden="true"></i> Voltar</paper-button>

            <template is="dom-if" if="{{ _permissions.create }}">
                <paper-button id="btnProjectAdd" class="tablinks" on-tap="_createNewProject"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp; Criar Novo</paper-button>
            </template>

            <paper-button id="btnProjectMovements" class="tablinks" on-tap="_OpenProjectMovements"><i class="fa fa-eye" aria-hidden="true"></i>&nbsp; Movimentos do Projeto</paper-button>

            <template is="dom-if" if="{{ data.verMenu }}">
                <paper-button id="btnPreProjectMovements" class="tablinks" on-tap="_OpenPreProjectMovements"><i class="fa fa-eye" aria-hidden="true"></i>&nbsp; Pré-Movimentos Projeto</paper-button>
                <paper-button id="btnProjectAdd" class="tablinks" on-tap="_terminarProject"><i class="fa fa-remove" aria-hidden="true"></i>&nbsp; Terminar</paper-button>

                <paper-button id="btnProjectDiary" class="tablinks" on-tap="_OpenProjectDiary"><i class="fa fa-eye" aria-hidden="true"></i>&nbsp; Diário de Projeto</paper-button>
                <paper-button id="btnProjectPreRegistration" class="tablinks" on-tap="_OpenProjectPreRegistration"><i class="fa fa-eye" aria-hidden="true"></i>&nbsp; Pré-Registo Projetos</paper-button>

                <template is="dom-if" if="{{ _permissions.create }}">
                    <paper-button id="btnInvoiceAut" class="tablinks" on-tap="_OpenInvoice"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp; Autorização Faturação</paper-button>
                </template>
            </template>

            <template is="dom-if" if="{{ data.enviarParaAprovacao }}">
                <paper-button id="btnEnviarAprovacao" class="tablinks" on-tap="_EnviarAprovacao"><i class="fa fa-arrow-right" aria-hidden="true"></i>&nbsp; Enviar Para Aprovação</paper-button>
            </template>

            <paper-button id="btn_imprimirMovimentos" class="tablinks" on-tap="_printMovimentos" title="Imprimir"><i class="fa fa-print" aria-hidden="true"></i> Imprimir Extrato</paper-button>

            <template is="dom-if" if="{{ _projectclosed }}">
                <paper-button id="btnReabrirProjeto" class="tablinks" on-tap="_ReabrirProjeto"><i class="fa fa-check" aria-hidden="true"></i>&nbsp; Reabrir Projeto</paper-button>
            </template>-->
            </div>
        </template>

        <template is="dom-if" if="{{ _isCreate }}">
            <div class="subMenu">
                <paper-button class="tablinks" on-tap="_goBack" title="Voltar"><i class="fa fa-arrow-left" aria-hidden="true"></i> Voltar</paper-button>

                <template is="dom-if" if="{{ _permissions.create }}">
                    <paper-button id="btnProjectAdd" class="tablinks" on-tap="_createNewProject"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp; Novo</paper-button>
                </template>
            </div>
        </template>

        <paper-tabs fit-container no-slide autoselect autoselect-delay="0" selected="{{selected}}">
            <paper-tab>Geral</paper-tab>
            <paper-tab>Envio</paper-tab>
            <paper-tab>AEC</paper-tab>
        </paper-tabs>

        <iron-pages selected="{{selected}}">
            <!--Geral-->
            <div>
                <div class="row">
                    <div class="col-lg-3">
                        <vaadin-text-field value="{{data.projectNo}}" maxlength="20" disabled="{{ !_isCreate }}" id="ProjectNo" name="ProjectNo" ed label="Nº Projeto"> </vaadin-text-field>
                    </div>

                    <div class="col-lg-3">
                        <vaadin-text-field value="{{data.description}}" maxlength="100" id="Description" name="Description" label="Descrição" disabled="{{ _bloqueado() }}" required error-message="Este campo é obrigatório"> </vaadin-text-field>
                    </div>

                    <div class="col-lg-3">
                        <vaadin-text-field value="{{data.clientNo}}" id="ProjectClientNo" label="Cliente Nº" disabled> </vaadin-text-field>
                    </div>

                    <div class="col-lg-3">
                        <such-selectbox id="ProjectClient" value="{{data.clientNo}}" label="Cliente" on-value-changed="_clientChanged"
                                        items="[[LProjectClients]]"
                                        text-path="name"
                                        value-path="no_"
                                        fields='[{"field":"no_", "name":"Nº Cliente"}, {"field":"name", "name":"Nome Cliente"}, {"field":"vatRegistrationNo_", "name":"Nº Contribuinte"}, {"field":"postCode", "name":"Cód. Postal"}, {"field":"city", "name":"Localidade"}, {"field":"regionCode", "name":"Região"}, {"field":"responsabilityCenterCode", "name":"C. Resp."}]'
                                        disabled="{{ _bloqueado() }}" required error-message="Este campo é obrigatório">
                        </such-selectbox>
                    </div>
                </div>

                <div class="row break_clear">
                    <div class="col-lg-3">
                        <vaadin-date-picker label="Data" id="Date" name="Date" value="{{data.date}}" disabled="{{ _bloqueado() }}"></vaadin-date-picker>
                    </div>

                    <div class="col-lg-3">
                        <vaadin-combo-box id="ProjectStatus" items="[[LProjectStatus]]" item-value-path="id" item-label-path="value" value="{{data.status}}" label="Estado" disabled>
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>

                    <div class="col-lg-3">
                        <such-selectbox id="ProjectLeader" value="{{data.projectLeader}}" label="Criador de Projeto" disabled
                                        items="[[LProjectEmployees]]"
                                        text-path="value"
                                        value-path="id"
                                        fields='[{"field":"id", "name":"Nº Mecanográfico"}, {"field":"value", "name":"Nome"}]'>
                        </such-selectbox>
                    </div>

                    <div class="col-lg-3">
                        <such-selectbox id="ProjectResponsible" value="{{data.projectResponsible}}" label="Validador de Projeto" disabled
                                        items="[[LProjectEmployees]]"
                                        text-path="value"
                                        value-path="id"
                                        fields='[{"field":"id", "name":"Nº Mecanográfico"}, {"field":"value", "name":"Nome"}]'>
                        </such-selectbox>
                    </div>
                </div>

                <div class="row break_clear">
                    <div class="col-lg-3">
                        <such-selectbox id="ObjectService" value="{{data.serviceObjectCode}}" label="Cód. Objeto Serviço"
                                        items="[[LProjectServiceObjects]]"
                                        text-path="value"
                                        value-path="id"
                                        fields='[{"field":"value", "name":"Nome Serviço"}]'
                                        disabled="{{ _bloqueado() }}">
                        </such-selectbox>
                    </div>

                    <div class="col-lg-3">
                        <such-selectbox id="ContractNo" value="{{data.contractNo}}" label="Nº Contrato"
                                        required error-message="Este campo é obrigatório"
                                        items="[[LProjectContracts]]"
                                        text-path="id"
                                        value-path="id"
                                        fields='[{"field":"id", "name":"Código"}, {"field":"value", "name":"Contrato"}]'
                                        disabled="{{ _bloqueado() }}">
                        </such-selectbox>
                    </div>

                    <div class="col-lg-3">
                        <vaadin-text-field value="{{data.ourProposal}}" maxlength="50" id="OurProposal" name="OurProposal" label="Nossa Proposta" disabled="{{ _bloqueado() }}"> </vaadin-text-field>
                    </div>

                    <div class="col-lg-3">
                        <vaadin-text-field value="{{data.commitmentCode}}" maxlength="50" id="CommitmentCode" name="CommitmentCode" label="Nº Compromisso" disabled="{{ _bloqueado() }}"> </vaadin-text-field>
                    </div>
                </div>

                <div class="row break_clear">
                    <div class="col-lg-3">
                        <such-selectbox id="RegionCode" value="{{data.regionCode}}" label="Cód. Região" disabled="{{ _bloqueado() }}"
                                        required error-message="Este campo é obrigatório"
                                        items="[[LProjectRegionCodes]]"
                                        text-path="value"
                                        value-path="id"
                                        fields='[{"field":"id", "name":"Código"}, {"field":"value", "name":"Região"}]'>
                        </such-selectbox>
                    </div>

                    <div class="col-lg-3">
                        <such-selectbox id="FunctionalAreaCode" value="{{data.functionalAreaCode}}" label="Cód. Área Funcional" disabled="{{ _bloqueado() }}"
                                        required error-message="Este campo é obrigatório"
                                        items="[[LProjectFunctionalAreaCodes]]"
                                        text-path="value"
                                        value-path="id"
                                        on-value-changed="_getGroupContabProjectType"
                                        fields='[{"field":"id", "name":"Código"}, {"field":"value", "name":"Área Funcional"}]'>
                        </such-selectbox>
                    </div>

                    <div class="col-lg-3">
                        <such-selectbox id="ResponsabilityCenterCode" value="{{data.responsabilityCenterCode}}" label="Cód. Centro Responsabilidade" disabled="{{ _bloqueado() }}"
                                        required error-message="Este campo é obrigatório"
                                        items="[[LProjectResponsabilityCenterCodes]]"
                                        text-path="value"
                                        value-path="id"
                                        fields='[{"field":"id", "name":"Código"}, {"field":"value", "name":"Centro Responsabilidade"}]'>
                        </such-selectbox>
                    </div>

                    <div class="col-lg-3">
                        <such-selectbox id="ClientRegionCode" value="{{data.clientRegionCode}}" label="Cliente Cód. Região" disabled
                                        items="[[LProjectRegionCodes]]"
                                        text-path="value"
                                        value-path="id"
                                        fields='[{"field":"id", "name":"Código"}, {"field":"value", "name":"Região"}]'>
                        </such-selectbox>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6">
                        <div class="row">
                            <div class="col-lg-6">
                                <such-selectbox value="{{data.groupContabProjectType}}" label="Tipo Grupo Contab. Projeto" disabled="{{ _bloqueado() }}"
                                                items="[[LProjectCountabGroupTypes]]"
                                                text-path="value"
                                                value-path="id"
                                                fields='[{"field":"value", "name":"Código"}, {"field":"extra", "name":"Descrição"}]'>
                                </such-selectbox>
                            </div>

                            <div class="col-lg-6">
                                <vaadin-text-field value="{{data.clientRequest}}" maxlength="20" id="ClientRequest" name="ClientRequest" label="Pedido do Cliente" disabled="{{ _bloqueado() }}"> </vaadin-text-field>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <vaadin-date-picker label="Data Pedido" id="RequestDate" name="Date" value="{{data.requestDate}}" disabled="{{ _bloqueado() }}"></vaadin-date-picker>
                            </div>

                            <div class="col-lg-6 alignPoga">
                                <vaadin-checkbox checked="{{data.billable}}" disabled="{{ _bloqueado() }}">Faturável</vaadin-checkbox>
                                <vaadin-checkbox checked="{{data.fechoAutomatico}}" disabled="{{ _bloqueado() }}">Fecho Automático</vaadin-checkbox>
                                <vaadin-checkbox checked="{{data.faturaPrecosIvaIncluido}}" disabled="{{ _bloqueado() }}">Fatura Preços IVA Incluído</vaadin-checkbox>
                            </div>
                        </div>
                    </div>


                    <div class="col-lg-6">
                        <such-textarea rows="5" value="{{data.detailedDescription}}" id="DetailedDescription" name="DetailedDescription" label="Descrição Detalhada" disabled="{{ _bloqueado() }}"> </such-textarea>
                    </div>
                </div>
            </div>

            <!--Envio-->
            <div>
                <div class="row">
                    <div class="col-lg-2">
                        <such-selectbox id="sbClientShippingAddresses" value="{{data.shippingAddressCode}}" label="Cód. Endereço Envio"
                                        items="[[ClientShippingAddresses]]"
                                        text-path="code"
                                        value-path="code"
                                        fields='[{"field":"code", "name":"Cód. Endereço"}, {"field":"name1", "name":"Nome"}, {"field":"name2", "name":"Nome 2"}, {"field":"address", "name":"Endereço"}, {"field":"city", "name":"Cidade"}]'
                                        disabled="{{ _bloqueado() }}"
                                        on-value-changed="_getAddressByCode">
                        </such-selectbox>
                    </div>

                    <div class="col-lg-5">
                        <vaadin-text-field value="{{data.shippingName}}" maxlength="100" id="ShippingName" name="ShippingName" label="Envio-a Nome" disabled> </vaadin-text-field>
                    </div>

                    <div class="col-lg-5">
                        <vaadin-text-field value="{{data.shippingName2}}" maxlength="100" id="ShippingName2" name="ShippingName2" label="Envio-a Nome 2" disabled> </vaadin-text-field>
                    </div>
                </div>

                <div class="row break_clear">
                    <div class="col-lg-4">
                        <vaadin-text-field value="{{data.shippingAddress}}" maxlength="100" id="ShippingAddress" name="ShippingAddress" label="Envio-a Endereço" disabled></vaadin-text-field>

                    </div>

                    <div class="col-lg-4">
                        <vaadin-text-field value="{{data.shippingAddress2}}" maxlength="100" id="ShippingAddress2" name="ShippingAddress2" label="Envio-a Endereço 2" disabled></vaadin-text-field>

                    </div>

                    <div class="col-lg-2">
                        <vaadin-text-field value="{{data.shippingPostalCode}}" maxlength="20" id="ShippingPostalCode" name="ShippingPostalCode" label="Envio-a Cód. Postal" disabled> </vaadin-text-field>
                    </div>

                    <div class="col-lg-2">
                        <vaadin-text-field value="{{data.shippingLocality}}" maxlength="30" id="ShippingLocality" name="ShippingLocality" label="Envio-a Localidade" disabled> </vaadin-text-field>
                    </div>
                </div>
            </div>

            <!--AEC-->
            <div>
                <div class="row">
                    <div class="col-lg-3">
                        <such-selectbox id="ProjectType" value="{{data.projectTypeCode}}" label="Tipo Projeto"
                                        items="[[LProjectTypes]]"
                                        text-path="value"
                                        value-path="id"
                                        fields='[{"field":"value", "name":"Descrição"}]'
                                        disabled="{{ _bloqueado() }}" required error-message="Este campo é obrigatório">
                        </such-selectbox>
                    </div>

                    <div class="col-lg-3">
                        <vaadin-combo-box items="[[LProjectCategories]]" item-value-path="id" item-label-path="value" value="{{data.projectCategory}}" label="Categoria Projeto" disabled="{{ _bloqueado() }}">
                            <template>
                                <paper-icon-item>
                                    <paper-item-body two-line>
                                        <div>[[item.value]]</div>
                                    </paper-item-body>
                                </paper-icon-item>
                            </template>
                        </vaadin-combo-box>
                    </div>

                    <div class="col-lg-3">
                        <such-selectbox id="BudgetContractNo" value="{{data.budgetContractNo}}" label="Nº Contrato Orçamento" disabled="{{ _bloqueado() }}"
                                        items="[[LProjectContracts]]"
                                        text-path="value"
                                        value-path="id"
                                        fields='[{"field":"id", "name":"Código"}, {"field":"value", "name":"Contrato Orçamento"}]'>
                        </such-selectbox>
                    </div>

                    <div class="col-lg-3 alignPoga">
                        <vaadin-checkbox checked="{{data.internalProject}}" disabled="{{ _bloqueado() }}">Projeto Interno</vaadin-checkbox>
                    </div>
                </div>
            </div>
        </iron-pages>

        <div class="marginSpace">
            <template is="dom-if" if="{{ _isCreate }}">
                <paper-button raised id="btnCreate" class="btnSave" on-tap="_create"><i class="fa fa-plus" aria-hidden="true"></i>&nbsp; Criar</paper-button>
            </template>

            <template is="dom-if" if="{{ !_isCreate }}">
                <template is="dom-if" if="{{ _permissions.update }}">
                    <paper-button raised id="btnUpdate" class="btnSave" on-tap="_update" hidden="{{ _bloqueado() }}"><i class="fa fa-floppy-o" aria-hidden="true"></i>&nbsp; Guardar</paper-button>
                </template>
                <template is="dom-if" if="{{ _permissions.delete }}">
                    <paper-button raised id="btnCancel" class="btnRemove" on-tap="_delete" hidden="{{ _bloqueado() }}"><i class="fa fa-trash-o" aria-hidden="true"></i>&nbsp; Eliminar</paper-button>

                </template>
            </template>
        </div>

        <paper-toast id="ToastMessageSuccess" duration="4000" horizontalAlign="right" class="toastSuccess">&nbsp;<i class="fa fa-check fa-lg" aria-hidden="true"></i></paper-toast>
        <paper-toast id="ToastMessageError" duration="4000" horizontalAlign="right" class="toastError">&nbsp;<i class="fa fa-exclamation-triangle" aria-hidden="true"></i></paper-toast>

        <paper-dialog id="rptDialog" class="dialgoBox" modal>
            <div class="buttons">
                <paper-button class="btnRemove" on-tap="_closeRptDialog" title="Fechar"><i class="fa fa-close" aria-hidden="true"></i>&nbsp; Fechar</paper-button>
            </div>
            <iframe id="rptContainer" src="" frameborder="0" style="width: 100%; height: 92%; margin: 0px; padding: 0px"></iframe>
        </paper-dialog>
    </template>

    <script>
        document.addEventListener('WebComponentsReady', function () {
            Polymer({
                is: 'x-projectdetails',
                properties: {
                    _permissions: {
                        type: Array
                    },
                    _projectid: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _coderegion: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _funcarea: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _respcode: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _codeclient: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    _contractno: {
                        type: String,
                        notify: true,
                        value: ""
                    },
                    selected: {
                        type: Number,
                        value: 0
                    },
                    _isCreate: {
                        type: Boolean,
                        value: false
                    },
                    _projectclosed: {
                        type: Boolean
                        //value: false
                    },

                    _coderegion: {
                        type: String,
                        notify: true,
                        value: ""
                    },

                    _funcarea: {
                        type: String,
                        notify: true,
                        value: ""
                    },

                    _respcode: {
                        type: String,
                        notify: true,
                        value: ""
                    },

                    _codeclient: {
                        type: String,
                        notify: true,
                        value: ""
                    },

                    _reportserverurl: {
                        type: String,
                    },

                    _viewMenuConsultarItems: {
                        type: Array,
                        value: [{ value: 1, description: "Movimentos Projeto" }, { value: 2, description: "Doc. Vendas Registados" }]
                    },
                    _viewMenuPreMovItems: {
                        type: Array,
                        value: [{ value: 1, description: "Diário Pré-Registos" }, { value: 2, description: "Pré-Movimentos Projeto" }]
                    },

                },
                ready: function () {
                    //GET PROJECT DATA
                    this.$.page_databound_ajax.body = JSON.stringify({ "ProjectNo": this._projectid });
                    this.$.page_databound_ajax.generateRequest();

                    if (this._projectid == "") {
                        this._isCreate = true;
                    }

                    if (this._contractno != "") {
                        this.$.RegionCode.value = this._coderegion;
                    }
                },

                _bloqueado: function () {
                    return this._projectclosed;
                },

                _openToast: function (message) {
                    this.$.ToastMessageSuccess.text = message;
                    this.$.ToastMessageSuccess.open();
                },
                _openToastError: function (message) {
                    this.$.ToastMessageError.text = message;
                    this.$.ToastMessageError.open();
                },
                _validateData: function () {
                    this.$.Description.validate();
                    this.$.ProjectClient.validate();
                    //this.$.ContractNo.validate();
                    this.$.ProjectLeader.validate();
                    if (this.$.ProjectStatus.value == 1) { this.$.ProjectResponsible.validate(); }
                    this.$.RegionCode.validate();
                    this.$.FunctionalAreaCode.validate();
                    this.$.ResponsabilityCenterCode.validate();
                    this.$.ProjectType.validate();

                    if (this.$.Description.value == "" || this.$.Description.value == undefined) {
                        this._openToastError("O campo Descrição é de preenchimento obrigatório.");
                        return false;
                    }
                    if (this.$.ProjectClient.value == "" || this.$.ProjectClient.value == undefined) {
                        this._openToastError("É obrigatória seleção de um Nº Cliente.");
                        return false;
                    }
                    //if (this.$.ContractNo.value == "" || this.$.ContractNo.value == undefined) {
                    //    this._openToastError("É obrigatória seleção de um Nº Contrato");
                    //    return false;
                    //}
                    //if (this.$.ProjectLeader.value == "" || this.$.ProjectLeader.value == undefined) {
                    //    this._openToastError("É obrigatória seleção de um Criador de Projeto.");
                    //    return false;
                    //}
                    if (this.$.ProjectStatus.value == 1 && (this.$.ProjectResponsible.value == "" || this.$.ProjectResponsible.value == undefined)) {
                        this._openToastError("É obrigatória seleção de um Validador de Projeto.");
                        return false;
                    }
                    if (this.$.RegionCode.value == "" || this.$.RegionCode.value == undefined) {
                        this._openToastError("É obrigatória seleção de um Cód. Região.");
                        return false;
                    }
                    if (this.$.FunctionalAreaCode.value == "" || this.$.FunctionalAreaCode.value == undefined) {
                        this._openToastError("É obrigatória seleção de um Cód. Área Funcional.");
                        return false;
                    }
                    if (this.$.ResponsabilityCenterCode.value == "" || this.$.ResponsabilityCenterCode.value == undefined) {
                        this._openToastError("É obrigatória seleção de um Cód. Centro Responsabilidade.");
                        return false;
                    }
                    if (this.$.ProjectType.value == "" || this.$.ProjectType.value == undefined) {
                        this._openToastError("É obrigatória seleção do Tipo de Projeto.");
                        return false;
                    }

                    return true;
                    //}

                    this._openToastError("Verifique os dados inseridos.");
                    return false;
                },
                _createNewProject: function () {
                    window.location.href = "../Detalhes/";
                },

                //CRUDS
                _create: function () {
                    if (this._validateData()) {
                        this.$.page_validator_ajax.body = JSON.stringify(this.data);
                        this.$.page_validator_ajax.generateRequest();
                    }
                },
                _update: function () {
                    if (this._validateData()) {
                        this._executeRequest("/Projetos/UpdateProject", this.data)
                    }
                },
                _delete: function () {
                    var Project = this.data;
                    var ajax_request = this.$.ajax_delete_project;
                    bootbox.confirm({
                        message: "Tem a certeza que pretende remover o projeto " + this.data.projectNo + "?",
                        buttons: {
                            confirm: {
                                label: 'Sim',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: 'Não',
                                className: 'btn-danger'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajax_request.body = JSON.stringify(Project);
                                ajax_request.generateRequest();
                            }
                        }
                    });
                },

                _terminarProject: function () {
                    var Project = this.data;
                    var ajax_request = this.$.ajax_terminar_project;
                    bootbox.confirm({
                        message: "Tem a certeza que pretende terminar o projeto " + this.data.projectNo + "?",
                        buttons: {
                            confirm: {
                                label: 'Sim',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: 'Não',
                                className: 'btn-danger'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajax_request.body = JSON.stringify(Project);
                                ajax_request.generateRequest();
                            }
                        }
                    });
                },

                _ReabrirProjeto: function () {
                    var Project = this.data;
                    var ajax_request = this.$.ajax_reabrir_project;
                    bootbox.confirm({
                        message: "Tem a certeza que pretende Reabrir o projeto " + this.data.projectNo + "?",
                        buttons: {
                            confirm: {
                                label: 'Sim',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: 'Não',
                                className: 'btn-danger'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajax_request.body = JSON.stringify(Project);
                                ajax_request.generateRequest();
                            }
                        }
                    });
                },

                //Responses Processors
                _responseProcessor: function (data) {
                    var self = this;

                    if (this.data.projectNo == "" || this.data.projectNo == undefined) {
                        this.data.status = 1;
                    }
                    //else {
                    //    if (this.data.status == 2) {
                    //        this._projectclosed = true;
                    //    }
                    //}

                    if (data.detail.status === 200) {
                        if (data.detail.url.indexOf("GetProject") !== -1) {
                            if (this.data.ProjectNo == "") {
                                this._isCreate = true;
                            } else {
                                if (this._contractno != "" && this._coderegion != "" && this._funcarea != "" && this._codeclient != "" && this._respcode != "" && (this.data.ProjectNo == "" || this.data.ProjectNo == undefined)) {
                                    this.$.FunctionalAreaCode.value = this._funcarea;
                                    this.$.RegionCode.value = this._coderegion;
                                    this.$.ResponsabilityCenterCode.value = this._respcode;
                                    this.$.ProjectClient.value = this._codeclient;
                                    this.$.ContractNo.value = this._contractno;
                                    this.data.clientNo = this._codeclient;
                                }

                                this.$.projects_ajax.body = JSON.stringify(this.data.clientNo);
                                this.$.projects_ajax.generateRequest();

                                this.$.shippinhAddress_ajax.body = JSON.stringify(this.data.clientNo);
                                this.$.shippinhAddress_ajax.generateRequest();

                                if (this.data.clientNo != "" && this.$.ProjectClient.valueText == "") {
                                    this._openToastError("Cliente não existe..")
                                }
                                //JP this._shippingAddressCode = this.data.shippingAddressCode;
                            }
                        } else if (data.detail.url.indexOf("Create") !== -1) {
                            this._createResponseProcessor();
                        } else if (data.detail.url.indexOf("Update") !== -1) {
                            if (this.data.eReasonCode != 1) {
                                this._openToastError(this.data.eMessage);
                            } else {
                                this._openToast("Projeto atualizado com sucesso.")
                            }
                        }
                    } else {
                        this._openToastError("Ocorreu um erro.")
                    }

                    this.$.page_getGroupContabProjectType_ajax.body = JSON.stringify(this.$.FunctionalAreaCode.value);
                    this.$.page_getGroupContabProjectType_ajax.generateRequest();
                },
                _createResponseProcessor: function () {
                    if (this.data.eReasonCode == 1) {
                        this._isCreate = false;
                        this._openToast("Projeto criado com sucesso.");
                        //window.location.href = "/Projetos/Detalhes/" + this.data.projectNo;
                    } else {
                        this._openToastError(this.data.eMessage);
                    }
                },
                _responseValidatorProcessor: function (data) {
                    var self = this;
                    if (data.detail.status === 200) {
                        if (this.validateResponse == "") {
                            this.data.status = this.$.ProjectStatus.value;
                            this._executeRequest("/Projetos/CreateProject", this.data)
                        } else {
                            this._openToastError(this.validateResponse);
                        }
                    }
                },
                _responseDeleteProcessor: function (data) {
                    var self = this;
                    if (data.detail.status === 200) {
                        if (this.deletedData.eReasonCode != 0) {
                            this._openToastError(this.deletedData.eMessage);
                        } else {
                            this._openToast(this.deletedData.eMessage);
                            setTimeout(
                                function () {
                                    window.location.href = "/";
                                }, 2500);
                        }
                    }
                },

                _responseTerminarProcessor: function (data) {
                    var self = this;
                    if (data.detail.status === 200) {
                        if (this.terminarData.eReasonCode != 0) {
                            this._openToastError(this.terminarData.eMessage);
                        } else {
                            this._openToast(this.terminarData.eMessage);
                            setTimeout(
                                function () {
                                    window.location.href = "/";
                                }, 2500);
                        }
                    }
                },

                _responseReabrirProcessor: function (data) {
                    var self = this;
                    if (data.detail.status === 200) {
                        if (this.reabrirData.eReasonCode != 0) {
                            this._openToastError(this.reabrirData.eMessage);
                        } else {
                            this._openToast(this.reabrirData.eMessage);
                            setTimeout(
                                function () {
                                    window.location.href = "/";
                                }, 2500);
                        }
                    }
                },

                _responseEnviarAprovacao: function (data) {
                    var self = this;
                    if (data.detail.status === 200) {
                        if (this.enviarAprovacao.eReasonCode != 1) {
                            this._openToastError(this.enviarAprovacao.eMessage);
                        } else {
                            this._openToast(this.enviarAprovacao.eMessage);
                            setTimeout(
                                function () {
                                    window.location.href = "/";
                                }, 2500);
                        }
                    }
                },

                _OpenInvoice: function (data) {
                    window.location.href = "../AutorizacaoFaturacao/" + this.data.projectNo;
                },

                _EnviarAprovacao: function (data) {
                    this.$.page_EnviarAprovacao_ajax.body = JSON.stringify(this.data);
                    this.$.page_EnviarAprovacao_ajax.generateRequest();
                },

                //Address Functions
                _getAddressByCode: function (e) {
                    var selItem = this.ClientShippingAddresses != null ? this.ClientShippingAddresses.find(x => x.code == e.detail.value) : null;
                    if (selItem != null) {
                        //Fill Data
                        this.$.ShippingName.value = selItem.name1;
                        this.$.ShippingName2.value = selItem.name2;
                        this.$.ShippingAddress.value = selItem.address1;
                        this.$.ShippingAddress2.value = selItem.address2;
                        this.$.ShippingPostalCode.value = selItem.zipCode;
                        this.$.ShippingLocality.value = selItem.city;
                    }
                    else {
                        var cliItem = this.LProjectClients != null ? this.LProjectClients.find(x => x.no_ == this.data.clientNo) : null;

                        if (cliItem != null) {
                            //Fill Data
                            this.$.ShippingName.value = cliItem.name;
                            this.$.ShippingName2.value = "";
                            this.$.ShippingAddress.value = cliItem.address1;
                            this.$.ShippingAddress2.value = cliItem.address2;
                            this.$.ShippingPostalCode.value = cliItem.postCode;
                            this.$.ShippingLocality.value = cliItem.city;
                        }
                        else {
                            this.$.ShippingName.value = "";
                            this.$.ShippingName2.value = "";
                            this.$.ShippingAddress.value = "";
                            this.$.ShippingAddress2.value = "";
                            this.$.ShippingPostalCode.value = "";
                            this.$.ShippingLocality.value = "";
                        }
                    }
                },

                //Helpers
                _executeRequest: function (url, data) {
                    this.$.page_databound_ajax.url = url;
                    this.$.page_databound_ajax.body = JSON.stringify(data);
                    this.$.page_databound_ajax.generateRequest();
                },
                //BUTTONS
                _OpenProjectMovements: function (url, data) {
                    window.location.href = "/Projetos/MovimentosDeProjeto/" + this.data.projectNo;
                },
                _OpenPreProjectMovements: function (url, data) {
                    window.location.href = "/Projetos/PreMovimentosProjetos/" + this.data.projectNo;
                },
                _OpenProjectPreRegistration: function (url, data) {
                    window.location.href = "/Projetos/PreregistoProjetos/" + this.data.projectNo;
                },
                _OpenProjectDiary: function (url, data) {
                    window.location.href = "../DiarioProjeto/" + this.data.projectNo;
                },


                //Client Change
                _clientChanged: function (e) {
                    if (e.detail.value != "") {
                        this.$.projects_ajax.body = JSON.stringify(e.detail.value);
                        this.$.projects_ajax.generateRequest();
                        this.$.ContractNo.value = "";

                        this.$.shippinhAddress_ajax.body = JSON.stringify(e.detail.value);
                        this.$.shippinhAddress_ajax.generateRequest();
                        this.data.shippingAddressCode = "";
                        this.$.sbClientShippingAddresses._clearSelection();
                    }
                    else {
                        this.$.ProjectClientNo.value = "";
                        this.$.ContractNo._clearSelection();

                        this.$.sbClientShippingAddresses._clearSelection();
                        this.$.ShippingName.value = "";
                        this.$.ShippingName2.value = "";
                        this.$.ShippingAddress.value = "";
                        this.$.ShippingAddress2.value = "";
                        this.$.ShippingPostalCode.value = "";
                        this.$.ShippingLocality.value = "";

                        this.$.projects_ajax.body = JSON.stringify(e.detail.value);
                        this.$.projects_ajax.generateRequest();
                        this.$.shippinhAddress_ajax.body = JSON.stringify(e.detail.value);
                        this.$.shippinhAddress_ajax.generateRequest();
                    }

                    if (this.data.clientNo != e.detail.value) {
                        this.$.ContractNo._clearSelection();
                    }
                },

                _goBack: function (e) {
                    window.history.back();
                },

                _printMovimentos: function () {
                    if (this._reportserverurl != undefined) {
                        this.$.rptContainer.src = this._reportserverurl + "ProjetoMovimentos&NoProjeto=" + this.data.projectNo + "&Utilizador=" + this.data.utilizador + "&DBName=" + this.data.nameDB + "&CompanyName=" + this.data.companyName;
                        this.$.rptDialog.open();
                    }
                    else {
                        this._openToastError("Não é possivel imprimir. Não foi definido o servidor de relatórios.");
                    }
                },
                _closeRptDialog: function () {
                    this.$.rptContainer.src = "about:blank";
                    this.$.rptDialog.close();
                },

                _getGroupContabProjectType: function () {
                    this.$.page_getGroupContabProjectType_ajax.body = JSON.stringify(this.$.FunctionalAreaCode.value);
                    this.$.page_getGroupContabProjectType_ajax.generateRequest();

                    this.$.page_GetAllResponsabilityCenterCodeFilterByAreaCode_ajax.body = JSON.stringify(this.$.FunctionalAreaCode.value);
                    this.$.page_GetAllResponsabilityCenterCodeFilterByAreaCode_ajax.generateRequest();
                },

                _viewMenuConsultarItemSelected: function (e) {
                    if (e.detail.value == 0)
                        return;
                    var item = e.detail.value;

                    if (item == null)
                        return;

                    switch (item.value) {
                        case 1: //"Movimentos Projeto"
                            this._OpenProjectMovements();
                            break;
                        case 2: //"Doc. Vendas Registados"
                            this._GoFaturasNotas();
                            break;
                    }
                },

                _viewMenuPreMovItemSelected: function (e) {
                    if (e.detail.value == 0)
                        return;
                    var item = e.detail.value;

                    if (item == null)
                        return;

                    switch (item.value) {
                        case 1: //"Diário Pré-Registos"
                            this._OpenProjectPreRegistration();
                            break;
                        case 2: //"Pré-Movimentos Projeto"
                            this._OpenPreProjectMovements();
                            break;
                    }
                },

                _GoFaturasNotas: function (url, data) {
                    window.location.href = "/Projetos/FaturasNotas_List/" + this.data.projectNo;

                    //debugger;

                    //this.$.ajax_GoFaturasNotas_ajax.body = JSON.stringify(this.data.projectNo);
                    //this.$.ajax_GoFaturasNotas_ajax.generateRequest();
                },

                _DuplicateProject: function () {
                    var Project = this.data;
                    var ajax_request = this.$.ajax_duplicar_project;
                    bootbox.confirm({
                        message: "Tem a certeza que pretende duplicar este projeto " + this.data.projectNo + "?",
                        buttons: {
                            confirm: {
                                label: 'Sim',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: 'Não',
                                className: 'btn-danger'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                ajax_request.body = JSON.stringify(Project);
                                ajax_request.generateRequest();
                            }
                        }
                    });
                },

                _responseDuplicarProcessor: function (data) {
                    var self = this;
                    if (data.detail.status === 200) {
                        if (this.duplicarData.eReasonCode != 0) {
                            this._openToastError(this.duplicarData.eMessage);
                        } else {
                            this._openToast(this.duplicarData.eMessage);
                            setTimeout(
                                function () {
                                    window.location.href = "/";
                                }, 2500);
                        }
                    }
                },

            });
        });
    </script>

</dom-module>


